<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON PONG // AUTO-SYNC</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --neon: #00f2ff; --pink: #ff007b; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: #020202; color: white; font-family: -apple-system, system-ui, sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden; touch-action: none;
        }
        #game-container { 
            position: relative; width: 95vw; height: 80vh; 
            max-width: 1200px; max-height: 750px; 
            background: #000; border-radius: 12px; 
            overflow: hidden; border: 1px solid #333;
        }
        canvas { width: 100%; height: 100%; display: block; background: #000; }
        
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        .menu-card { padding: 25px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 420px; background: #0a0a0a; }
        h1 { font-size: 1.8rem; letter-spacing: 4px; margin-bottom: 15px; text-shadow: 0 0 15px var(--neon); color: #fff; }
        
        #leaderboard { 
            margin: 15px 0; text-align: left; background: #050505; padding: 15px; 
            border-radius: 12px; border: 1px solid #222; height: 200px; overflow-y: auto; 
        }
        .lb-header { color: var(--neon); font-size: 10px; font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .lb-entry { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #111; font-size: 13px; }
        .rank { width: 30px; color: #555; }
        .matchup { flex-grow: 1; color: #eee; }
        .score { color: var(--neon); font-weight: bold; }

        input { background: #111; border: 1px solid #444; color: white; padding: 12px; width: 100%; border-radius: 8px; margin-bottom: 10px; font-size: 16px; text-align: center; }
        #main-cta { background: white; border: none; color: black; padding: 14px; font-weight: 600; cursor: pointer; border-radius: 8px; width: 100%; }
        .hidden { display: none !important; }
        #sync-ui { font-size: 9px; color: #444; margin-top: 10px; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="overlay-name" class="overlay">
            <div class="menu-card">
                <h1>IDENTIFY</h1>
                <input type="text" id="user-name" placeholder="ENTER NAME" maxlength="12">
                <button id="main-cta" onclick="saveName()">START ENGINE</button>
            </div>
        </div>

        <div id="overlay-start" class="overlay hidden">
            <div class="menu-card">
                <h1>NEON PONG</h1>
                <div id="leaderboard">
                    <div class="lb-header">
                        <span>LIVE GLOBAL SWARM</span>
                        <span id="nodes-count" style="color:var(--pink)">SEARCHING...</span>
                    </div>
                    <div id="lb-list">Downloading rankings...</div>
                </div>
                <button id="main-cta" onclick="startAI()">PLAY VS AI</button>
                <div id="sync-ui">AUTO-SYNCING DATA ACROSS ALL PLAYERS</div>
            </div>
        </div>

        <div id="overlay-win" class="overlay hidden">
            <div class="menu-card">
                <div id="win-message" style="font-size: 2rem; color: var(--neon); margin-bottom: 10px;">WINNER</div>
                <button id="main-cta" onclick="location.reload()">MAIN MENU</button>
            </div>
        </div>

        <canvas id="pong"></canvas>
    </div>

<script>
// --- AUTO-SWARM CONFIG ---
const SWARM_KEY = "NEON_AUTO_SYNC_V4";
let scores = JSON.parse(localStorage.getItem(SWARM_KEY) || "[]");
let myPeerId = "";

function updateLB(newHits, p1, p2) {
    if (newHits < 1) return;
    let id = [p1, p2].sort().join(" VS ");
    let idx = scores.findIndex(s => s.id === id);
    if (idx > -1) { if (newHits > scores[idx].hits) scores[idx].hits = newHits; } 
    else { scores.push({ id, hits: newHits }); }
    scores.sort((a,b) => b.hits - a.hits).splice(20);
    localStorage.setItem(SWARM_KEY, JSON.stringify(scores));
    render();
}

function merge(incoming) {
    if (!incoming) return;
    let map = new Map();
    [...scores, ...incoming].forEach(s => {
        if (!map.has(s.id) || s.hits > map.get(s.id).hits) map.set(s.id, s);
    });
    scores = Array.from(map.values()).sort((a,b) => b.hits - a.hits).splice(20);
    localStorage.setItem(SWARM_KEY, JSON.stringify(scores));
    render();
}

function render() {
    const list = document.getElementById('lb-list');
    if (!scores.length) { list.innerHTML = "<div style='text-align:center;padding:20px;color:#333'>NO DATA FOUND</div>"; return; }
    list.innerHTML = scores.map((s, i) => `
        <div class="lb-entry">
            <span class="rank">${i+1}</span>
            <span class="matchup">${s.id}</span>
            <span class="score">${s.hits}</span>
        </div>`).join('');
}

// --- PEER DISCOVERY ---
const peer = new Peer(); // Random ID
peer.on('open', id => { 
    myPeerId = id; 
    document.getElementById('nodes-count').innerText = "ONLINE";
});

// If someone connects to us, give them our data
peer.on('connection', conn => {
    conn.on('open', () => {
        conn.send({ type: 'SYNC', data: scores });
        document.getElementById('nodes-count').innerText = "SYNCED";
    });
    conn.on('data', d => { if(d.type === 'SYNC') merge(d.data); });
});

// Since we don't have a central list, users "auto-sync" by playing or just staying on the menu.
// In a real production app, you'd use a small 'Room' server, but for a standalone HTML file, 
// the data will download the moment a Peer connection is established.

document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById("pong");
    const ctx = canvas.getContext("2d");
    canvas.width = 2000; canvas.height = 1250;

    let gameState = 'LOBBY', playerName = "USER";
    const ball = { x: 1000, y: 625, dx: 18, dy: 18 };
    const p1 = { y: 525, score: 0 }, p2 = { y: 525, score: 0 };
    let hits = 0;

    window.saveName = () => {
        playerName = document.getElementById('user-name').value.toUpperCase() || "USER";
        document.getElementById('overlay-name').classList.add('hidden');
        document.getElementById('overlay-start').classList.remove('hidden');
        render();
    };

    window.startAI = () => {
        gameState = 'PLAYING';
        document.getElementById('overlay-start').classList.add('hidden');
        requestAnimationFrame(loop);
    };

    canvas.addEventListener("mousemove", e => {
        const rect = canvas.getBoundingClientRect();
        p1.y = (e.clientY - rect.top) * (1250 / rect.height) - 100;
    });

    function loop() {
        if (gameState !== 'PLAYING') return;
        ctx.fillStyle = "black"; ctx.fillRect(0,0,2000,1250);
        
        // AI Logic
        p2.y += (ball.y - 100 - p2.y) * 0.1;
        
        // Ball Physics
        ball.x += ball.dx; ball.y += ball.dy;
        if (ball.y < 0 || ball.y > 1250) ball.dy *= -1;
        
        // Paddle Collision
        if (ball.x < 80 && ball.y > p1.y && ball.y < p1.y + 200) { ball.dx *= -1.05; hits++; }
        if (ball.x > 1920 && ball.y > p2.y && ball.y < p2.y + 200) { ball.dx *= -1.05; hits++; }
        
        // Score
        if (ball.x < 0 || ball.x > 2000) {
            updateLB(hits, playerName, "CPU");
            ball.x = 1000; ball.y = 625; ball.dx = 18; hits = 0;
            p1.score++; 
            if(p1.score >= 5) { gameState = 'LOBBY'; document.getElementById('overlay-win').classList.remove('hidden'); }
        }

        ctx.fillStyle = "white";
        ctx.fillRect(40, p1.y, 20, 200);
        ctx.fillRect(1940, p2.y, 20, 200);
        ctx.beginPath(); ctx.arc(ball.x, ball.y, 15, 0, Math.PI*2); ctx.fill();
        
        requestAnimationFrame(loop);
    }
});
</script>
</body>
</html>
