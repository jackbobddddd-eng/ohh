<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NEON PONG // CROSS-PLATFORM</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --neon: #00f2ff; --pink: #ff007b; }
        * { touch-action: none; -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }
        html, body { 
            background: #020202; color: white; font-family: -apple-system, system-ui, sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; width: 100%; margin: 0; overflow: hidden; position: fixed;
        }
        
        /* CONTAINER FIX: Keeps game at 16:10 ratio so iPad sees everything */
        #game-container { 
            position: relative; 
            background: #000; 
            border-radius: 12px; 
            overflow: hidden; 
            border: 1px solid #333;
            box-shadow: 0 0 20px rgba(0,0,0,1);
            /* Dimensions are handled by JS now for perfect fit */
        }

        canvas { width: 100%; height: 100%; display: block; background: #000; }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: flex; align-items: center; justify-content: center; z-index: 10; }
        .menu-card { padding: 30px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); width: 85%; max-width: 400px; background: #0a0a0a; }
        h1 { font-size: 2.2rem; font-weight: 200; letter-spacing: 8px; margin-bottom: 20px; text-shadow: 0 0 15px var(--neon); color: #fff; }
        
        .mode-select { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 15px 0; }
        .mode-btn { background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 11px; }
        .mode-btn.active { border-color: var(--neon); background: rgba(0, 242, 255, 0.1); box-shadow: 0 0 10px var(--neon); }
        
        input { background: #111; border: 1px solid #444; color: white; padding: 12px; width: 85%; border-radius: 8px; margin-bottom: 10px; font-size: 16px; text-align: center; }
        #main-cta { background: white; border: none; color: black; padding: 14px 30px; font-weight: 600; cursor: pointer; border-radius: 8px; width: 95%; margin-top: 10px; }
        
        #leaderboard { 
            margin: 15px 0; font-size: 13px; color: #888; text-align: left; background: #111; 
            padding: 12px; border-radius: 10px; border: 1px solid #222; height: 180px; 
            overflow-y: auto; -webkit-overflow-scrolling: touch; 
        }
        #leaderboard::-webkit-scrollbar { width: 4px; }
        #leaderboard::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        
        .lb-entry { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #1a1a1a; padding-bottom: 4px; }
        .hidden { display: none !important; }
        .id-text { font-size: 10px; color: #444; margin-top: 12px; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="overlay-name" class="overlay">
            <div class="menu-card">
                <h1>IDENTIFY</h1>
                <input type="text" id="user-name" placeholder="YOUR NAME" maxlength="12">
                <button id="main-cta" onclick="saveName()">ENTER LOBBY</button>
            </div>
        </div>

        <div id="overlay-start" class="overlay hidden">
            <div class="menu-card">
                <h1>NEON PONG</h1>
                <div id="leaderboard">
                    <div style="color:var(--neon); margin-bottom: 10px; font-weight:bold; text-align:center; position:sticky; top:0; background:#111; padding-bottom:5px; border-bottom:1px solid #222;">
                        üèÜ LONGEST RALLIES
                    </div>
                    <div id="lb-list">No records yet.</div>
                </div>
                <div class="mode-select">
                    <button class="mode-btn" onclick="setAI('EASY')">EASY</button>
                    <button class="mode-btn active" onclick="setAI('MEDIUM')">MEDIUM</button>
                    <button class="mode-btn" onclick="setAI('HARD')">HARD</button>
                </div>
                <button id="main-cta" onclick="startAI()">START AI SIMULATION</button>
                <hr style="border:0; border-top:1px solid #222; margin: 20px 0;">
                <input type="text" id="join-id" placeholder="Paste Peer ID"><br>
                <button class="mode-btn" style="width: 95%;" onclick="connectToPeer()">JOIN MULTIPLAYER</button>
                <div class="id-text" onclick="copyId()">ID: <span id="my-id" style="color:var(--pink)">...</span></div>
            </div>
        </div>

        <div id="overlay-win" class="overlay hidden">
            <div class="menu-card">
                <div id="win-message" style="font-size: 2rem; color: var(--neon); margin-bottom: 5px;">PLAYER WINS</div>
                <div id="win-versus" style="font-size: 0.9rem; color: #888; margin-bottom: 15px;">P1 VS P2</div>
                <p id="win-detail" style="color: #666; margin-bottom: 20px;"></p>
                <button id="main-cta" onclick="resetMatch()">PLAY AGAIN</button>
            </div>
        </div>

        <canvas id="pong"></canvas>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById("pong");
    const container = document.getElementById("game-container");
    const ctx = canvas.getContext("2d");
    
    // Internal Game Resolution (Fixed)
    canvas.width = 2000; 
    canvas.height = 1250; 
    
    const PADDLE_H = 200; 
    const PADDLE_W = 20;
    const BALL_R = 20;

    let gameState = 'LOBBY', mode = 'AI', isHost = true, conn = null;
    let speedMult = 1, shake = 0;
    let currentVolley = 0;
    let maxMatchVolley = 0; 
    let aiLevel = 'MEDIUM';
    let particles = [], playerName = "PILOT", opponentName = "CPU", dataReceived = false;
    const WIN_SCORE = 7;
    const keys = {};

    const p1 = { y: 525, score: 0, targetY: 525 };
    const p2 = { y: 525, score: 0, targetY: 525 };
    const ball = { x: 1000, y: 625, dx: 15, dy: 15 };

    // --- FIX 1: FORCE ASPECT RATIO ON ALL DEVICES (iPad fix) ---
    function resizeGame() {
        const aspect = 2000 / 1250; // 1.6 ratio
        const winW = window.innerWidth;
        const winH = window.innerHeight;
        const padding = 20; // safe area

        let newW = winW - padding;
        let newH = newW / aspect;

        if (newH > winH - padding) {
            newH = winH - padding;
            newW = newH * aspect;
        }

        container.style.width = `${newW}px`;
        container.style.height = `${newH}px`;
    }
    window.addEventListener('resize', resizeGame);
    resizeGame(); // Trigger immediately
    // -----------------------------------------------------------

    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y;
            this.vx = (Math.random() - 0.5) * 35; this.vy = (Math.random() - 0.5) * 35;
            this.alpha = 1; this.color = color; this.size = Math.random() * 8 + 2;
        }
        update() { this.x += this.vx; this.y += this.vy; this.alpha -= 0.03; }
        draw() {
            ctx.save(); ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.size, this.size); ctx.restore();
        }
    }

    window.saveName = () => {
        playerName = document.getElementById('user-name').value.trim() || "PILOT";
        document.getElementById('overlay-name').classList.add('hidden');
        document.getElementById('overlay-start').classList.remove('hidden');
    };

    window.setAI = (lvl) => {
        aiLevel = lvl;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    };

    window.startAI = () => { mode = 'AI'; isHost = true; opponentName = "CPU"; startGame(); };

    function startGame() {
        if(gameState === 'PLAYING') return;
        gameState = 'PLAYING';
        document.getElementById('overlay-start').classList.add('hidden');
        document.getElementById('overlay-win').classList.add('hidden');
        gameLoop(); 
    }

    window.resetMatch = () => {
        p1.score = 0; p2.score = 0; currentVolley = 0; maxMatchVolley = 0;
        resetBall();
        if(isHost && mode === 'MULTIPLAYER' && conn) conn.send({ type: 'RESET_REBOOT' });
        startGame();
    };

    function updateLB(v) {
        if (v < 2) return; 
        let s = JSON.parse(localStorage.getItem('pong_v12') || '[]');
        s.push({ pair: `${playerName} & ${opponentName}`, v: v });
        s.sort((a,b) => b.v - a.v);
        localStorage.setItem('pong_v12', JSON.stringify(s.slice(0, 20)));
        renderLB();
    }

    function renderLB() {
        const list = document.getElementById('lb-list');
        let s = JSON.parse(localStorage.getItem('pong_v12') || '[]');
        list
