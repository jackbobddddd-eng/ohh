<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON PONG // ULTIMATE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --neon: #00f2ff; --pink: #ff007b; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: #020202; color: white; font-family: -apple-system, system-ui, sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden; touch-action: none;
        }
        #game-container { 
            position: relative; width: 95vw; height: 80vh; 
            max-width: 1200px; max-height: 750px; 
            background: #000; border-radius: 12px; 
            overflow: hidden; border: 1px solid #333;
        }
        canvas { width: 100%; height: 100%; display: block; background: #000; }
        
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        .menu-card { padding: 25px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 420px; background: #0a0a0a; }
        h1 { font-size: 1.8rem; letter-spacing: 4px; margin-bottom: 15px; text-shadow: 0 0 15px var(--neon); color: #fff; }
        
        .mode-select { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 15px 0; }
        .mode-btn { background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 10px; }
        .mode-btn.active { border-color: var(--neon); background: rgba(0, 242, 255, 0.1); box-shadow: 0 0 10px var(--neon); }
        
        input { background: #111; border: 1px solid #444; color: white; padding: 12px; width: 100%; border-radius: 8px; margin-bottom: 10px; font-size: 16px; text-align: center; outline: none; }
        #main-cta { background: white; border: none; color: black; padding: 14px; font-weight: 600; cursor: pointer; border-radius: 8px; width: 100%; margin-top: 5px; }
        .secondary-btn { background: transparent; border: 1px solid #444; color: #888; padding: 10px; border-radius: 8px; width: 100%; margin-top: 10px; cursor: pointer; font-size: 12px; }
        
        #leaderboard { 
            margin: 15px 0; text-align: left; background: #050505; padding: 15px; 
            border-radius: 12px; border: 1px solid #222; 
            height: 200px; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
        }
        .lb-header { color: var(--neon); font-size: 10px; font-weight: bold; margin-bottom: 10px; position: sticky; top: 0; background: #050505; padding-bottom: 5px; border-bottom: 1px solid #222; }
        .lb-entry { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #111; font-size: 13px; }
        .rank { width: 30px; color: #555; font-weight: bold; }
        .matchup { flex-grow: 1; color: #eee; font-weight: 300; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; }
        .score { color: var(--neon); font-weight: bold; min-width: 70px; text-align: right; }
        
        #leaderboard::-webkit-scrollbar { width: 4px; }
        #leaderboard::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        .hidden { display: none !important; }
        .id-text { font-size: 10px; color: #444; margin-top: 15px; cursor: pointer; }

        /* PEER DRAWER & CHAT */
        #peer-toggle { position: fixed; top: 20px; right: 20px; z-index: 100; background: #111; border: 1px solid var(--neon); color: var(--neon); padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold; }
        #peer-drawer { position: fixed; top: 60px; right: 20px; width: 250px; background: #0a0a0a; border: 1px solid #333; border-radius: 10px; z-index: 99; padding: 15px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .peer-list-item { padding: 8px; border-bottom: 1px solid #222; font-size: 12px; cursor: pointer; display: flex; justify-content: space-between; }
        .peer-list-item:hover { background: #1a1a1a; }
        #chat-box { height: 150px; overflow-y: auto; background: #000; margin-top: 10px; padding: 5px; font-size: 11px; border-radius: 5px; border: 1px solid #222; }
        #chat-input { margin-top: 5px; font-size: 12px; padding: 8px; border: 1px solid #333; }
    </style>
</head>
<body>

    <button id="peer-toggle" onclick="togglePeers()">PEERS (0)</button>
    <div id="peer-drawer" class="hidden">
        <div style="font-size: 10px; color: var(--neon); margin-bottom: 10px; border-bottom: 1px solid #333;">SAVED CONTACTS</div>
        <div id="peer-list"></div>
        <div id="chat-box"></div>
        <input type="text" id="chat-input" placeholder="Message..." onkeydown="if(event.key==='Enter') sendChat()">
    </div>

    <div id="game-container">
        <div id="overlay-name" class="overlay">
            <div class="menu-card">
                <h1>IDENTIFY</h1>
                <input type="text" id="user-name" placeholder="YOUR NAME" maxlength="12">
                <button id="main-cta" onclick="saveName()">PROCEED</button>
            </div>
        </div>

        <div id="overlay-start" class="overlay hidden">
            <div class="menu-card">
                <h1>NEON PONG</h1>
                <div id="leaderboard">
                    <div class="lb-header">ALL-TIME RANKINGS (HIGH TO LOW)</div>
                    <div id="lb-list">Fresh data stream...</div>
                </div>
                
                <div class="mode-select">
                    <button class="mode-btn" onclick="setAI('EASY')">EASY</button>
                    <button class="mode-btn active" onclick="setAI('MEDIUM')">MEDIUM</button>
                    <button class="mode-btn" onclick="setAI('HARD')">HARD</button>
                </div>
                <button id="main-cta" onclick="startAI()">START AI</button>
                <input type="text" id="join-id" placeholder="Paste Peer ID" style="margin-top:15px">
                <button class="mode-btn" style="width: 100%;" onclick="connectToPeer()">JOIN MULTIPLAYER</button>
                <div class="id-text" onclick="copyId()">MY PERMANENT ID: <span id="my-id" style="color:var(--pink)">LOADING...</span></div>
            </div>
        </div>

        <div id="overlay-win" class="overlay hidden">
            <div class="menu-card">
                <div id="win-message" style="font-size: 2rem; color: var(--neon); margin-bottom: 10px;">WINNER</div>
                <div id="rally-stat" style="color: #666; margin-bottom: 20px;"></div>
                <button id="main-cta" onclick="requestRematch()">REMATCH</button>
                <button class="secondary-btn" onclick="location.reload()">QUIT</button>
            </div>
        </div>

        <canvas id="pong"></canvas>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById("pong");
    const ctx = canvas.getContext("2d");
    canvas.width = 2000; canvas.height = 1250; 

    let gameState = 'LOBBY', mode = 'AI', isHost = true, conn = null, peer = null;
    let speedMult = 1, shake = 0, currentVolley = 0, aiLevel = 'MEDIUM';
    let particles = [], playerName = "PILOT", opponentName = "CPU";
    
    const STORAGE_KEY = 'pong_v7';
    const CONTACTS_KEY = 'pong_contacts_v1';
    const MY_ID_KEY = 'pong_saved_peer_id'; // Key to save your ID
    const WIN_SCORE = 7;
    const p1 = { y: 525, score: 0, targetY: 525 };
    const p2 = { y: 525, score: 0, targetY: 525 };
    const ball = { x: 1000, y: 625, dx: 18, dy: 18 };

    // --- ID PERSISTENCE LOGIC ---
    function initPeer() {
        let savedId = localStorage.getItem(MY_ID_KEY);
        // Create peer with saved ID if exists, otherwise let server assign and then save it
        peer = savedId ? new Peer(savedId) : new Peer();
        
        peer.on('open', id => {
            localStorage.setItem(MY_ID_KEY, id); // Always save it
            document.getElementById('my-id').innerText = id;
            console.log("Peer Connection Open. ID:", id);
        });

        peer.on('connection', c => {
            conn = c; isHost = true; mode = 'MULTIPLAYER';
            setupPeer();
            conn.on('open', () => { 
                savePeer(conn.peer, "REMOTE PLAYER");
                conn.send({ type: 'START', hostName: playerName });
                conn.send({ type: 'LB_SYNC', data: JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') });
                startGame(); 
            });
        });

        peer.on('error', err => {
            if(err.type === 'unavailable-id') {
                console.log("ID taken, generating new one...");
                localStorage.removeItem(MY_ID_KEY);
                initPeer();
            }
        });
    }

    window.saveName = () => {
        const val = document.getElementById('user-name').value.trim();
        if(val) { 
            playerName = val.toUpperCase(); 
            document.getElementById('overlay-name').classList.add('hidden'); 
            document.getElementById('overlay-start').classList.remove('hidden');
            initPeer(); // Initialize networking only after name is set
        }
    };

    // Keep all other logic strictly the same
    window.setAI = (lvl) => {
        aiLevel = lvl;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    };

    window.startAI = () => { mode = 'AI'; isHost = true; opponentName = "CPU"; startGame(); };

    function startGame() {
        p1.score = 0; p2.score = 0; resetBall();
        gameState = 'PLAYING';
        document.getElementById('overlay-start').classList.add('hidden');
        document.getElementById('overlay-win').classList.add('hidden');
        requestAnimationFrame(gameLoop);
    }

    window.requestRematch = () => {
        if (mode === 'AI') startGame();
        else if (conn) { conn.send({ type: 'REMATCH_REQ' }); startGame(); }
    };

    function updateLB(v) {
        if (v < 1 || !isHost) return; 
        let names = [playerName, opponentName].sort();
        let matchID = `${names[0]} VS ${names[1]}`;
        let s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        let existing = s.find(item => item && item.id === matchID);
        if (existing) { if (v > existing.hits) existing.hits = v; } 
        else { s.push({ id: matchID, hits: v }); }
        s.sort((a, b) => b.hits - a.hits);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
        renderLB();
        if (conn) conn.send({ type: 'LB_SYNC', data: s });
    }

    function renderLB() {
        const list = document.getElementById('lb-list');
        let s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        if (s.length === 0) { list.innerHTML = `<div style="text-align:center; padding:20px; color:#222; font-size: 11px;">NO MATCHES RECORDED</div>`; return; }
        list.innerHTML = s.map((x, i) => `<div class="lb-entry"><span class="rank">${i + 1}.</span><span class="matchup">${x.id}</span><span class="score">${x.hits} HITS</span></div>`).join('');
    }
    renderLB();

    window.togglePeers = () => document.getElementById('peer-drawer').classList.toggle('hidden');
    
    function savePeer(id, name) {
        let contacts = JSON.parse(localStorage.getItem(CONTACTS_KEY) || '{}');
        contacts[id] = name || 'UNKNOWN';
        localStorage.setItem(CONTACTS_KEY, JSON.stringify(contacts));
        renderPeers();
    }

    function renderPeers() {
        const list = document.getElementById('peer-list');
        const contacts = JSON.parse(localStorage.getItem(CONTACTS_KEY) || '{}');
        const keys = Object.keys(contacts);
        document.getElementById('peer-toggle').innerText = `PEERS (${keys.length})`;
        list.innerHTML = keys.map(id => `<div class="peer-list-item" onclick="document.getElementById('join-id').value='${id}'"><span>${contacts[id]}</span><span style="font-size:8px; color:#444">${id.substring(0,6)}...</span></div>`).join('');
    }
    renderPeers();

    window.sendChat = () => {
        const inp = document.getElementById('chat-input');
        if(!inp.value || !conn) return;
        conn.send({ type: 'CHAT', msg: inp.value, from: playerName });
        addChat(playerName, inp.value);
        inp.value = '';
    };

    function addChat(user, msg) {
        const box = document.getElementById('chat-box');
        box.innerHTML += `<div><b style="color:var(--neon)">${user}:</b> ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    window.connectToPeer = () => {
        const id = document.getElementById('join-id').value.trim();
        if(!id) return;
        conn = peer.connect(id); isHost = false; mode = 'MULTIPLAYER';
        setupPeer();
        conn.on('open', () => { savePeer(id, "FRIEND"); conn.send({ type: 'JOIN', guestName: playerName }); startGame(); });
    };

    function setupPeer() {
        conn.on('data', data => {
            if (data.type === 'START') { opponentName = data.hostName.toUpperCase(); savePeer(conn.peer, opponentName); }
            if (data.type === 'JOIN') { opponentName = data.guestName.toUpperCase(); savePeer(conn.peer, opponentName); }
            if (data.type === 'CHAT') addChat(data.from, data.msg);
            if (data.type === 'WIN') endMatch(data.winner);
            if (data.type === 'REMATCH_REQ') startGame();
            if (data.type === 'LB_SYNC') { localStorage.setItem(STORAGE_KEY, JSON.stringify(data.data)); renderLB(); }
            if (isHost) p2.targetY = data.p2Y;
            else { p1.y = data.p1Y; p2.y = data.p2Y; ball.x = data.ballX; ball.y = data.ballY; p1.score = data.s1; p2.score = data.s2; speedMult = data.speed; currentVolley = data.vol; }
        });
    }

    // Standard Particle/Update/Draw classes from original
    class P { constructor(x,y,c){this.x=x;this.y=y;this.vx=(Math.random()-0.5)*45;this.vy=(Math.random()-0.5)*45;this.alpha=1;this.color=c;this.size=Math.random()*10+3;} update(){this.x+=this.vx;this.y+=this.vy;this.alpha-=0.03;} draw(){ctx.save();ctx.globalAlpha=this.alpha;ctx.fillStyle=this.color;ctx.shadowBlur=15;ctx.shadowColor=this.color;ctx.fillRect(this.x,this.y,this.size,this.size);ctx.restore();}}
    function burst(x, y, c) { for(let i=0; i<15; i++) particles.push(new P(ball.x, ball.y, c)); }

    function update() {
        if (gameState !== 'PLAYING') return;
        p1.y += (p1.targetY - p1.y) * 0.2;
        if (mode === 'AI') { let s = aiSettings[aiLevel]; p2.y += (ball.y - 100 + (Math.sin(Date.now()/150)*s.margin) - p2.y) * s.reaction; } else { p2.y += (p2.targetY - p2.y) * 0.2; }
        if (isHost || mode === 'AI') {
            speedMult += 0.002; ball.x += ball.dx * speedMult; ball.y += ball.dy * speedMult;
            if (ball.y <= 0 || ball.y >= canvas.height) { ball.dy *= -1; shake = 10; burst(ball.x, ball.y, 'white'); }
            if (ball.x < 80 && ball.y > p1.y && ball.y < p1.y + 200) { ball.dx = Math.abs(ball.dx); shake = 20; currentVolley++; burst(60, ball.y, '#00f2ff'); }
            if (ball.x > 1920 && ball.y > p2.y && ball.y < p2.y + 200) { ball.dx = -Math.abs(ball.dx); shake = 20; currentVolley++; burst(1940, ball.y, '#ff007b'); }
            if (ball.x < 0) { p2.score++; updateLB(currentVolley); resetBall(); }
            if (ball.x > 2000) { p1.score++; updateLB(currentVolley); resetBall(); }
            if (p1.score >= WIN_SCORE || p2.score >= WIN_SCORE) endMatch(p1.score >= WIN_SCORE ? playerName : opponentName);
            if (conn) conn.send({ p1Y: p1.y, p2Y: p2.y, ballX: ball.x, ballY: ball.y, s1: p1.score, s2: p2.score, speed: speedMult, vol: currentVolley });
        } else if (conn) conn.send({ p2Y: p2.targetY });
        particles.forEach((p, i) => { p.update(); if(p.alpha <= 0) particles.splice(i, 1); });
    }

    function resetBall() { ball.x = 1000; ball.y = 625; ball.dx = (Math.random() > 0.5 ? 22 : -22); ball.dy = (Math.random() > 0.5 ? 16 : -16); speedMult = 1; currentVolley = 0; }
    function endMatch(w) { gameState = 'END'; document.getElementById('overlay-win').classList.remove('hidden'); document.getElementById('win-message').innerText = w + " WINS"; document.getElementById('rally-stat').innerText = `Rally: ${currentVolley} hits`; if(conn && isHost) conn.send({ type: 'WIN', winner: w }); }

    function draw() {
        ctx.fillStyle = "black"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.save(); if (shake > 1) { ctx.translate(Math.random()*shake, Math.random()*shake); shake *= 0.9; }
        ctx.font = "100 250px sans-serif"; ctx.fillStyle = "rgba(255,255,255,0.05)"; ctx.textAlign = "center";
        ctx.fillText(p1.score, 600, 450); ctx.fillText(p2.score, 1400, 450);
        ctx.shadowBlur = 20; ctx.fillStyle = "white";
        ctx.shadowColor = "#00f2ff"; ctx.fillRect(40, p1.y, 20, 200);
        ctx.shadowColor = "#ff007b"; ctx.fillRect(1940, p2.y, 20, 200);
        ctx.shadowColor = "white"; ctx.beginPath(); ctx.arc(ball.x, ball.y, 15, 0, Math.PI*2); ctx.fill();
        particles.forEach(p => p.draw()); ctx.restore();
    }

    function gameLoop() { update(); draw(); if(gameState === 'PLAYING') requestAnimationFrame(gameLoop); }
    window.copyId = () => { navigator.clipboard.writeText(document.getElementById('my-id').innerText); alert("ID Copied"); };
});
</script>
</body>
</html>
