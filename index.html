<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON PONG // CLOUD</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --neon: #00f2ff; --pink: #ff007b; }
        * { box-sizing: border-box; }
        body { 
            background: #020202; color: white; font-family: sans-serif;
            display: flex; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden;
        }
        #game-container { position: relative; width: 95vw; height: 85vh; max-width: 1000px; background: #000; border: 1px solid #333; border-radius: 10px; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10; }
        .menu-card { padding: 20px; border-radius: 15px; text-align: center; background: #0a0a0a; border: 1px solid #222; width: 320px; }
        h1 { font-size: 1.5rem; letter-spacing: 2px; color: var(--neon); margin-bottom: 20px; }
        #leaderboard { background: #050505; border: 1px solid #222; height: 180px; overflow-y: auto; margin-bottom: 15px; text-align: left; padding: 10px; border-radius: 5px; }
        .lb-entry { display: flex; justify-content: space-between; font-size: 12px; padding: 5px 0; border-bottom: 1px solid #111; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; background: #111; border: 1px solid #333; color: white; border-radius: 5px; }
        button { width: 100%; padding: 12px; background: white; color: black; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; margin-top: 5px; }
        .hidden { display: none !important; }
        .status { font-size: 9px; color: #444; margin-top: 10px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="overlay-name" class="overlay">
        <div class="menu-card">
            <h1>IDENTIFY</h1>
            <input type="text" id="user-name" placeholder="Enter Name..." maxlength="12">
            <button onclick="saveName()">START</button>
        </div>
    </div>

    <div id="overlay-start" class="overlay hidden">
        <div class="menu-card">
            <h1>NEON PONG</h1>
            <div id="leaderboard">
                <div style="font-size: 9px; color: var(--neon); border-bottom: 1px solid #333; margin-bottom: 5px;">GLOBAL TOP SCORES</div>
                <div id="lb-list">Loading...</div>
            </div>
            <button onclick="startAI()">PLAY VS CPU</button>
            <button style="background: #111; color: #666; font-size: 10px;" onclick="connectToPeer()">MULTIPLAYER</button>
            <div class="status">ID: <span id="my-id">...</span></div>
        </div>
    </div>

    <div id="overlay-win" class="overlay hidden">
        <div class="menu-card">
            <h1 id="win-message">WINNER</h1>
            <p id="rally-stat" style="color: #666;"></p>
            <button onclick="location.reload()">PLAY AGAIN</button>
        </div>
    </div>

    <canvas id="pong"></canvas>
</div>

<script>
const BIN_ID = '6786e88cacd35132e70df44b';
const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
const API_KEY = "$2a$10$C98V9iS.NlU8F.9Uq1xGGeO2D6fW6V9M/9f/O8U3Qy.8y.G8y.G8y";
let gameState = 'LOBBY';
let playerName = "PILOT";

// REFRESH DATA
async function fetchLB() {
    try {
        const res = await fetch(`${API_URL}/latest?meta=false&t=${Date.now()}`, { 
            headers: { "X-Master-Key": API_KEY }
        });
        const data = await res.json();
        const list = document.getElementById('lb-list');
        if (data.scores && data.scores.length > 0) {
            list.innerHTML = data.scores.map((s, i) => 
                `<div class="lb-entry"><span>${i+1}. ${s.id}</span><span>${s.hits}</span></div>`
            ).join('');
        } else {
            list.innerHTML = "<div style='color:#333; text-align:center;'>No scores yet. Score a point to start!</div>";
        }
    } catch (e) { console.log("Refresh failed"); }
}

// UPDATE DATA
async function updateLB(hits, p1, p2) {
    if (hits < 1) return;
    try {
        const res = await fetch(`${API_URL}/latest?meta=false`, { headers: { "X-Master-Key": API_KEY }});
        const data = await res.json();
        let scores = data.scores || [];
        let matchID = [p1, p2].sort().join(" vs ");
        let existing = scores.find(s => s.id === matchID);
        if (existing) { if (hits > existing.hits) existing.hits = hits; } 
        else { scores.push({ id: matchID, hits: hits }); }
        scores.sort((a,b) => b.hits - a.hits);
        
        await fetch(API_URL, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY, 'X-Bin-Versioning': 'false' },
            body: JSON.stringify({ scores: scores.slice(0, 20) })
        });
        fetchLB();
    } catch (e) { console.log("Update failed"); }
}

// POLL EVERY 5 SECONDS (Safest for public APIs)
setInterval(() => { if(gameState === 'LOBBY') fetchLB(); }, 5000);

// GAME LOGIC
const canvas = document.getElementById("pong");
const ctx = canvas.getContext("2d");
canvas.width = 1000; canvas.height = 600;

let p1 = { y: 250, score: 0, targetY: 250 };
let p2 = { y: 250, score: 0 };
let ball = { x: 500, y: 300, dx: 5, dy: 5 };
let currentVolley = 0;

function saveName() {
    const n = document.getElementById('user-name').value.trim();
    if(n) { playerName = n.toUpperCase(); document.getElementById('overlay-name').classList.add('hidden'); document.getElementById('overlay-start').classList.remove('hidden'); fetchLB(); }
}

function startAI() {
    p1.score = 0; p2.score = 0; currentVolley = 0;
    gameState = 'PLAYING';
    document.getElementById('overlay-start').classList.add('hidden');
    resetBall();
    loop();
}

function resetBall() { ball.x = 500; ball.y = 300; ball.dx *= -1; ball.dy = (Math.random()-0.5)*10; }

canvas.addEventListener("mousemove", e => {
    const rect = canvas.getBoundingClientRect();
    p1.targetY = (e.clientY - rect.top) * (600/rect.height) - 50;
});

function loop() {
    if(gameState !== 'PLAYING') return;
    ctx.fillStyle = "black"; ctx.fillRect(0,0,1000,600);
    
    // Paddle Physics
    p1.y += (p1.targetY - p1.y) * 0.2;
    p2.y += (ball.y - 50 - p2.y) * 0.1;

    // Ball Physics
    ball.x += ball.dx; ball.y += ball.dy;
    if(ball.y < 0 || ball.y > 600) ball.dy *= -1;
    
    if(ball.x < 30 && ball.y > p1.y && ball.y < p1.y + 100) { ball.dx = Math.abs(ball.dx) * 1.05; currentVolley++; }
    if(ball.x > 970 && ball.y > p2.y && ball.y < p2.y + 100) { ball.dx = -Math.abs(ball.dx) * 1.05; currentVolley++; }
    
    if(ball.x < 0 || ball.x > 1000) {
        if(ball.x < 0) p2.score++; else p1.score++;
        updateLB(currentVolley, playerName, "CPU");
        if(p1.score >= 5 || p2.score >= 5) {
            gameState = 'LOBBY';
            document.getElementById('overlay-win').classList.remove('hidden');
            document.getElementById('win-message').innerText = (p1.score >= 5 ? playerName : "CPU") + " WINS";
            document.getElementById('rally-stat').innerText = `Best Rally: ${currentVolley} hits`;
        } else {
            resetBall();
            currentVolley = 0;
        }
    }

    // Draw
    ctx.fillStyle = "white";
    ctx.fillRect(10, p1.y, 15, 100);
    ctx.fillRect(975, p2.y, 15, 100);
    ctx.beginPath(); ctx.arc(ball.x, ball.y, 8, 0, Math.PI*2); ctx.fill();
    ctx.font = "30px Arial"; ctx.globalAlpha = 0.2;
    ctx.fillText(p1.score, 400, 50); ctx.fillText(p2.score, 600, 50); ctx.globalAlpha = 1;

    requestAnimationFrame(loop);
}

const peer = new Peer();
peer.on('open', id => document.getElementById('my-id').innerText = id);
function connectToPeer() { const id = prompt("Enter Friend ID"); }
</script>
</body>
</html>
