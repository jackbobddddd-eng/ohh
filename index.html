<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON PONG // GLOBAL</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --neon: #00f2ff; --pink: #ff007b; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: #020202; color: white; font-family: -apple-system, system-ui, sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden; touch-action: none;
        }
        #game-container { 
            position: relative; width: 95vw; height: 80vh; 
            max-width: 1200px; max-height: 750px; 
            background: #000; border-radius: 12px; 
            overflow: hidden; border: 1px solid #333;
        }
        canvas { width: 100%; height: 100%; display: block; }
        
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        .menu-card { padding: 25px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 420px; background: #0a0a0a; }
        h1 { font-size: 1.8rem; letter-spacing: 4px; margin-bottom: 15px; text-shadow: 0 0 15px var(--neon); color: #fff; }
        
        #leaderboard { 
            margin: 15px 0; text-align: left; background: #050505; padding: 15px; 
            border-radius: 12px; border: 1px solid #222; height: 180px; 
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .lb-header { color: var(--neon); font-size: 10px; font-weight: bold; margin-bottom: 10px; position: sticky; top: 0; background: #050505; border-bottom: 1px solid #222; }
        .lb-entry { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #111; font-size: 13px; }
        .rank { width: 30px; color: var(--pink); font-weight: bold; }
        .matchup { flex-grow: 1; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .score { color: var(--neon); font-weight: bold; min-width: 70px; text-align: right; }
        
        input { background: #111; border: 1px solid #444; color: white; padding: 12px; width: 100%; border-radius: 8px; margin-bottom: 10px; font-size: 16px; text-align: center; outline: none; }
        #main-cta { background: white; border: none; color: black; padding: 14px; font-weight: 600; cursor: pointer; border-radius: 8px; width: 100%; margin-top: 5px; }
        .mode-btn { background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="overlay-name" class="overlay">
            <div class="menu-card">
                <h1>IDENTIFY</h1>
                <input type="text" id="user-name" placeholder="YOUR NAME" maxlength="12">
                <button id="main-cta" onclick="saveName()">ENTER GAME</button>
            </div>
        </div>

        <div id="overlay-start" class="overlay hidden">
            <div class="menu-card">
                <h1>NEON PONG</h1>
                <div id="leaderboard">
                    <div class="lb-header">GLOBAL LIVE RANKINGS</div>
                    <div id="lb-list">Syncing with cloud...</div>
                </div>
                <button id="main-cta" onclick="startAI()">START AI</button>
                <input type="text" id="join-id" placeholder="Paste Peer ID" style="margin-top:15px">
                <button class="mode-btn" style="width: 100%;" onclick="connectToPeer()">JOIN MULTIPLAYER</button>
            </div>
        </div>

        <div id="overlay-win" class="overlay hidden">
            <div class="menu-card">
                <div id="win-message" style="font-size: 2rem; color: var(--neon); margin-bottom: 10px;">WINNER</div>
                <div id="rally-stat" style="color: #666; margin-bottom: 20px;"></div>
                <button id="main-cta" onclick="requestRematch()">REMATCH</button>
                <button class="mode-btn" style="width:100%; margin-top:10px" onclick="location.reload()">QUIT</button>
            </div>
        </div>
        <canvas id="pong"></canvas>
    </div>

<script>
// --- GLOBAL SYNC LOGIC ---
// Using a public bin service for global persistence
const BIN_ID = "65a41e97dc7465401894458d"; // This acts as our global cloud save
const API_URL = `https://api.jsonbin.io/v3/b/6786e88cacd35132e70df44b`; // Public access link
const API_KEY = "$2a$10$C98V9iS.NlU8F.9Uq1xGGeO2D6fW6V9M/9f/O8U3Qy.8y.G8y.G8y"; // Master key for updates

async function fetchGlobalLB() {
    try {
        const res = await fetch(API_URL + "/latest", { headers: { "X-Master-Key": API_KEY }});
        const data = await res.json();
        renderLB(data.record.scores);
    } catch (e) { console.error("LB Fetch Failed"); }
}

async function updateGlobalLB(v, pName, oName) {
    if (v < 1) return;
    try {
        const res = await fetch(API_URL + "/latest", { headers: { "X-Master-Key": API_KEY }});
        let data = await res.json();
        let scores = data.record.scores || [];
        
        let matchID = [pName, oName].sort().join(" VS ");
        let existing = scores.find(s => s.id === matchID);
        
        if (existing) {
            if (v > existing.hits) existing.hits = v;
        } else {
            scores.push({ id: matchID, hits: v });
        }
        
        scores.sort((a, b) => b.hits - a.hits);
        
        await fetch(API_URL, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
            body: JSON.stringify({ scores: scores.slice(0, 50) }) // Keep top 50 globally
        });
        renderLB(scores);
    } catch (e) { console.error("LB Update Failed"); }
}

function renderLB(scores) {
    const list = document.getElementById('lb-list');
    if (!scores || scores.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:20px; color:#222;">NO GLOBAL DATA</div>`;
        return;
    }
    list.innerHTML = scores.map((x, i) => `
        <div class="lb-entry">
            <span class="rank">${i + 1}</span>
            <span class="matchup">${x.id}</span>
            <span class="score">${x.hits} HITS</span>
        </div>`).join('');
}

// --- GAME LOGIC ---
document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById("pong");
    const ctx = canvas.getContext("2d");
    canvas.width = 2000; canvas.height = 1250; 

    let gameState = 'LOBBY', mode = 'AI', isHost = true, conn = null;
    let playerName = "PILOT", opponentName = "CPU", currentVolley = 0;
    const p1 = { y: 525, score: 0, targetY: 525 }, p2 = { y: 525, score: 0, targetY: 525 };
    const ball = { x: 1000, y: 625, dx: 18, dy: 18 };

    fetchGlobalLB(); // Initial load

    window.saveName = () => {
        playerName = document.getElementById('user-name').value.trim().toUpperCase() || "ANON";
        document.getElementById('overlay-name').classList.add('hidden');
        document.getElementById('overlay-start').classList.remove('hidden');
    };

    window.startAI = () => { mode = 'AI'; isHost = true; opponentName = "CPU"; startGame(); };

    function startGame() {
        p1.score = 0; p2.score = 0; resetBall();
        gameState = 'PLAYING';
        document.querySelectorAll('.overlay').forEach(o => o.classList.add('hidden'));
        requestAnimationFrame(gameLoop);
    }

    function resetBall() {
        ball.x = 1000; ball.y = 625;
        ball.dx = (Math.random() > 0.5 ? 22 : -22);
        ball.dy = (Math.random() > 0.5 ? 16 : -16);
        currentVolley = 0;
    }

    function update() {
        if (gameState !== 'PLAYING') return;
        p1.y += (p1.targetY - p1.y) * 0.2;
        if (mode === 'AI') p2.y += (ball.y - 100 - p2.y) * 0.1;
        else p2.y += (p2.targetY - p2.y) * 0.2;

        ball.x += ball.dx; ball.y += ball.dy;
        if (ball.y <= 0 || ball.y >= 1250) ball.dy *= -1;
        
        if (ball.x < 80 && ball.y > p1.y && ball.y < p1.y + 200) { ball.dx = Math.abs(ball.dx); currentVolley++; }
        if (ball.x > 1920 && ball.y > p2.y && ball.y < p2.y + 200) { ball.dx = -Math.abs(ball.dx); currentVolley++; }

        if (ball.x < 0 || ball.x > 2000) {
            if (ball.x < 0) p2.score++; else p1.score++;
            updateGlobalLB(currentVolley, playerName, opponentName);
            resetBall();
            if (p1.score >= 7 || p2.score >= 7) {
                gameState = 'END';
                document.getElementById('overlay-win').classList.remove('hidden');
                document.getElementById('win-message').innerText = (p1.score >= 7 ? playerName : opponentName) + " WINS";
            }
        }
    }

    function draw() {
        ctx.fillStyle = "black"; ctx.fillRect(0, 0, 2000, 1250);
        ctx.fillStyle = "white";
        ctx.fillRect(40, p1.y, 20, 200); ctx.fillRect(1940, p2.y, 20, 200);
        ctx.beginPath(); ctx.arc(ball.x, ball.y, 15, 0, Math.PI*2); ctx.fill();
        ctx.font = "100px sans-serif"; ctx.fillText(p1.score, 800, 150); ctx.fillText(p2.score, 1150, 150);
    }

    function gameLoop() { update(); draw(); if(gameState === 'PLAYING') requestAnimationFrame(gameLoop); }
    
    // Paddle control
    canvas.addEventListener("touchmove", e => {
        const rect = canvas.getBoundingClientRect();
        const y = (e.touches[0].clientY - rect.top) * (1250/rect.height) - 100;
        p1.targetY = y;
        e.preventDefault();
    }, {passive: false});
});
</script>
</body>
</html>
