<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON PONG // GLOBAL SYNC</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --neon: #00f2ff; --pink: #ff007b; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: #020202; color: white; font-family: -apple-system, system-ui, sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden; touch-action: none;
        }
        #game-container { 
            position: relative; width: 95vw; height: 80vh; 
            max-width: 1200px; max-height: 750px; 
            background: #000; border-radius: 12px; 
            overflow: hidden; border: 1px solid #333;
        }
        canvas { width: 100%; height: 100%; display: block; background: #000; }
        
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        .menu-card { padding: 25px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 420px; background: #0a0a0a; }
        h1 { font-size: 1.8rem; letter-spacing: 4px; margin-bottom: 15px; text-shadow: 0 0 15px var(--neon); color: #fff; }
        
        input { background: #111; border: 1px solid #444; color: white; padding: 12px; width: 100%; border-radius: 8px; margin-bottom: 10px; font-size: 16px; text-align: center; outline: none; }
        #main-cta { background: white; border: none; color: black; padding: 14px; font-weight: 600; cursor: pointer; border-radius: 8px; width: 100%; margin-top: 5px; }
        .mode-btn { background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 10px; }
        
        #leaderboard { 
            margin: 15px 0; text-align: left; background: #050505; padding: 15px; 
            border-radius: 12px; border: 1px solid #222; height: 200px; overflow-y: auto; 
        }
        .lb-header { color: var(--neon); font-size: 10px; font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .lb-entry { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #111; font-size: 12px; }
        .matchup { flex-grow: 1; color: #eee; }
        .score { color: var(--neon); font-weight: bold; }

        #chat-ui {
            position: fixed; bottom: 20px; right: 20px; width: 280px; z-index: 100;
        }
        #chat-box {
            height: 300px; background: #0a0a0a; border: 1px solid #333; border-radius: 10px;
            display: flex; flex-direction: column; overflow: hidden; margin-bottom: 10px;
        }
        #chat-messages { flex-grow: 1; padding: 10px; overflow-y: auto; font-size: 11px; color: #ccc; }
        #chat-input { width: 100%; background: #111; border: none; padding: 10px; color: white; border-top: 1px solid #333; }
        .chat-toggle { background: var(--pink); border: none; color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; float: right; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="overlay-name" class="overlay">
            <div class="menu-card">
                <h1>IDENTIFY</h1>
                <input type="text" id="user-name" placeholder="YOUR NAME" maxlength="12">
                <button id="main-cta" onclick="saveName()">ENTER WORLD</button>
            </div>
        </div>

        <div id="overlay-start" class="overlay hidden">
            <div class="menu-card">
                <h1>NEON PONG</h1>
                <div id="leaderboard">
                    <div class="lb-header">
                        <span>GLOBAL SYNCED RANKINGS</span>
                        <span id="sync-status" style="color:var(--pink)">OFFLINE</span>
                    </div>
                    <div id="lb-list">Connecting to swarm...</div>
                </div>
                <button id="main-cta" onclick="startAI()">SOLO VS AI</button>
                <input type="text" id="join-id" placeholder="Friend's Name" style="margin-top:15px">
                <button class="mode-btn" style="width: 100%;" onclick="connectToPeer()">PLAY FRIEND</button>
            </div>
        </div>
        <canvas id="pong"></canvas>
    </div>

    <div id="chat-ui">
        <div id="chat-box" class="hidden">
            <div id="chat-messages"></div>
            <input type="text" id="chat-input" placeholder="Global chat..." onkeydown="if(event.key==='Enter') sendGlobalChat()">
        </div>
        <button class="chat-toggle" onclick="document.getElementById('chat-box').classList.toggle('hidden')">CHAT</button>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById("pong");
    const ctx = canvas.getContext("2d");
    canvas.width = 2000; canvas.height = 1250; 

    let gameState = 'LOBBY', mode = 'AI', isHost = true, conn = null, peer = null;
    let playerName = "PILOT", opponentName = "CPU";
    const STORAGE_KEY = 'pong_swarm_v1';
    let swarmConnections = [];
    
    const p1 = { y: 525, score: 0, targetY: 525 };
    const p2 = { y: 525, score: 0, targetY: 525 };
    const ball = { x: 1000, y: 625, dx: 18, dy: 18 };
    let currentVolley = 0;

    window.saveName = () => {
        const val = document.getElementById('user-name').value.trim();
        if(val) {
            playerName = val.toUpperCase();
            document.getElementById('overlay-name').classList.add('hidden');
            document.getElementById('overlay-start').classList.remove('hidden');
            initNetwork();
        }
    };

    function initNetwork() {
        peer = new Peer("NP_" + playerName);
        peer.on('open', () => {
            document.getElementById('sync-status').innerText = "ONLINE";
            document.getElementById('sync-status').style.color = "var(--neon)";
            renderLB();
        });
        peer.on('connection', c => handleIncoming(c));
    }

    function handleIncoming(c) {
        c.on('open', () => {
            swarmConnections.push(c);
            c.send({ type: 'SYNC', lb: getLB() });
            addChatMessage("System", `${c.peer.replace("NP_", "")} connected.`);
        });
        setupDataListener(c);
    }

    window.connectToPeer = () => {
        const target = document.getElementById('join-id').value.toUpperCase().trim();
        if(!target) return;
        const c = peer.connect("NP_" + target);
        c.on('open', () => {
            swarmConnections.push(c);
            c.send({ type: 'SYNC', lb: getLB() });
            isHost = false; mode = 'MULTIPLAYER';
            opponentName = target;
            startGame();
        });
        setupDataListener(c);
    };

    function setupDataListener(c) {
        c.on('data', data => {
            if(data.type === 'SYNC') mergeLB(data.lb);
            if(data.type === 'CHAT') addChatMessage(data.user, data.msg);
            if(data.type === 'START') { opponentName = data.hostName; startGame(); }
            if(isHost) p2.targetY = data.p2Y;
            else if(data.type === 'GAME_DATA') {
                p1.y = data.p1Y; p2.y = data.p2Y; ball.x = data.ballX; ball.y = data.ballY;
            }
        });
    }

    function getLB() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }

    function mergeLB(incoming) {
        let local = getLB();
        let map = new Map();
        [...local, ...incoming].forEach(x => {
            if(!map.has(x.id) || x.hits > map.get(x.id).hits) map.set(x.id, x);
        });
        let final = Array.from(map.values()).sort((a,b) => b.hits - a.hits).slice(0, 50);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(final));
        renderLB();
    }

    function renderLB() {
        const list = document.getElementById('lb-list');
        let s = getLB();
        if(!s.length) { list.innerHTML = "No synced data."; return; }
        list.innerHTML = s.map(x => `
            <div class="lb-entry">
                <span class="matchup">${x.id}</span>
                <span class="score">${x.hits}</span>
            </div>`).join('');
    }

    window.sendGlobalChat = () => {
        const input = document.getElementById('chat-input');
        if(!input.value) return;
        const msgData = { type: 'CHAT', user: playerName, msg: input.value };
        swarmConnections.forEach(c => c.send(msgData));
        addChatMessage(playerName, input.value);
        input.value = '';
    };

    function addChatMessage(u, m) {
        const box = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.innerHTML = `<b style="color:var(--neon)">${u}:</b> ${m}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    window.startAI = () => { mode = 'AI'; isHost = true; opponentName = "CPU"; startGame(); };

    function startGame() {
        gameState = 'PLAYING';
        document.getElementById('overlay-start').classList.add('hidden');
        requestAnimationFrame(loop);
    }

    function loop() {
        if(gameState !== 'PLAYING') return;
        ctx.fillStyle = "black"; ctx.fillRect(0,0,2000,1250);
        p1.y += (p1.targetY - p1.y) * 0.2;
        if(mode === 'AI') p2.y += (ball.y - 100 - p2.y) * 0.1;
        if(isHost) {
            ball.x += ball.dx; ball.y += ball.dy;
            if(ball.y < 0 || ball.y > 1250) ball.dy *= -1;
            if(ball.x < 80 && ball.y > p1.y && ball.y < p1.y+200) { ball.dx = Math.abs(ball.dx); currentVolley++; }
            if(ball.x > 1920 && ball.y > p2.y && ball.y < p2.y+200) { ball.dx = -Math.abs(ball.dx); currentVolley++; }
            if(ball.x < 0 || ball.x > 2000) {
                mergeLB([{id: `${playerName} vs ${opponentName}`, hits: currentVolley}]);
                ball.x = 1000; currentVolley = 0;
            }
            swarmConnections.forEach(c => c.send({type:'GAME_DATA', p1Y:p1.y, p2Y:p2.y, ballX:ball.x, ballY:ball.y}));
        }
        ctx.fillStyle = "white"; ctx.fillRect(40, p1.y, 20, 200); ctx.fillRect(1940, p2.y, 20, 200);
        ctx.beginPath(); ctx.arc(ball.x, ball.y, 15, 0, Math.PI*2); ctx.fill();
        requestAnimationFrame(loop);
    }

    canvas.addEventListener("mousemove", e => {
        const rect = canvas.getBoundingClientRect();
        p1.targetY = (e.clientY - rect.top) * (1250 / rect.height) - 100;
        if(!isHost) swarmConnections.forEach(c => c.send({p2Y: p1.targetY}));
    });
});
</script>
</body>
</html>
