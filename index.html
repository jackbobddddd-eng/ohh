<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NEON PONG // IPAD FIX</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --neon: #00f2ff; --pink: #ff007b; }
        * { touch-action: none; -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; }
        html, body { background: #000; margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; display: flex; align-items: center; justify-content: center; font-family: sans-serif; }
        #game-container { position: relative; aspect-ratio: 16 / 10; width: 100%; max-height: 100%; max-width: 100%; background: #000; border: 2px solid #222; margin: auto; }
        canvas { display: block; width: 100%; height: 100%; }
        .overlay { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.95); display: flex; align-items: center; justify-content: center; z-index: 10; padding: 20px; }
        .menu-card { padding: 30px; border-radius: 20px; text-align: center; border: 1px solid #333; width: 100%; max-width: 500px; background: #050505; color: white; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        h1 { font-size: clamp(1.5rem, 8vw, 2.5rem); letter-spacing: 5px; text-shadow: 0 0 15px var(--neon); margin: 0 0 20px 0; }
        input { width: 100%; padding: 18px; margin-bottom: 12px; background: #111; border: 1px solid #444; color: white; border-radius: 12px; font-size: 1.1rem; text-align: center; }
        button { width: 100%; padding: 18px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 10px; transition: 0.2s; }
        .primary-btn { background: white; color: black; }
        .sec-btn { background: var(--pink); color: white; }
        .tertiary-btn { background: #222; color: #aaa; border: 1px solid #444; }
        #leaderboard { background: #111; height: 120px; overflow-y: auto; margin: 15px 0; padding: 15px; border-radius: 12px; text-align: left; font-size: 0.9rem; border: 1px solid #222; }
        .lb-row { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding: 5px 0; }
        .hidden { display: none !important; }
        .status-msg { font-size: 0.8rem; margin-top: 10px; color: var(--neon); }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="screen-name" class="overlay">
            <div class="menu-card">
                <h1>NEON PONG</h1>
                <input type="text" id="in-name" placeholder="ENTER YOUR NAME" maxlength="10">
                <button class="primary-btn" onclick="uiSaveName()">CONTINUE</button>
            </div>
        </div>

        <div id="screen-menu" class="overlay hidden">
            <div class="menu-card">
                <h1>LOBBY</h1>
                <div id="leaderboard"><div id="lb-content">No match history yet.</div></div>
                <button class="primary-btn" onclick="startSinglePlayer()">PLAY VS CPU</button>
                <div style="margin:20px 0; border-top:1px solid #333; position:relative;"><span style="position:absolute; top:-12px; left:45%; background:#050505; padding:0 10px; color:#444;">OR</span></div>
                <input type="text" id="in-peer" placeholder="PASTE OPPONENT ID">
                <button id="btn-join" class="sec-btn" onclick="joinMultiplayer()">JOIN MULTIPLAYER</button>
                <p style="font-size:0.8rem; color:#666; margin-top:15px; cursor: pointer;" onclick="copyMyID()">MY ID: <span id="display-id" style="color:var(--neon); font-weight:bold; text-decoration:underline;">CONNECTING...</span></p>
                <div id="status" class="status-msg"></div>
            </div>
        </div>

        <div id="screen-win" class="overlay hidden">
            <div class="menu-card">
                <h2 id="win-txt" style="font-size:3rem; color:var(--neon); margin:0;">WINNER!</h2>
                <p id="rally-txt" style="font-size:1.2rem; color:#888;">Best Rally: 0</p>
                <button class="primary-btn" onclick="location.reload()">BACK TO MENU</button>
            </div>
        </div>

        <canvas id="stage"></canvas>
    </div>

<script>
    const canvas = document.getElementById('stage');
    const ctx = canvas.getContext('2d');
    const GW = 2000, GH = 1250;
    canvas.width = GW; canvas.height = GH;

    let state = 'MENU', isHost = true, peerConn = null;
    let name = "PLAYER", oppName = "CPU";
    let score = [0, 0], rally = 0, bestRally = 0;
    
    const ball = { x: GW/2, y: GH/2, dx: 16, dy: 16, r: 20, speed: 1 };
    const p1 = { y: 525, h: 220, w: 25, targetY: 525 };
    const p2 = { y: 525, h: 220, w: 25, targetY: 525 };

    // --- INPUT ---
    function movePaddle(clientY) {
        const rect = canvas.getBoundingClientRect();
        const scale = GH / rect.height;
        const pos = (clientY - rect.top) * scale - (p1.h / 2);
        if (isHost) p1.targetY = pos; else p2.targetY = pos;
    }
    canvas.addEventListener('mousemove', e => movePaddle(e.clientY));
    canvas.addEventListener('touchmove', e => { movePaddle(e.touches[0].clientY); e.preventDefault(); }, { passive: false });

    // --- PEERJS CORE ---
    const peer = new Peer();
    peer.on('open', id => document.getElementById('display-id').innerText = id);
    
    peer.on('connection', c => {
        peerConn = c; 
        isHost = true;
        document.getElementById('status').innerText = "Connecting to player...";
        setupSocket();
    });

    function joinMultiplayer() {
        const id = document.getElementById('in-peer').value.trim();
        if(!id) { alert("Please paste an ID first!"); return; }
        
        document.getElementById('btn-join').innerText = "JOINING...";
        peerConn = peer.connect(id);
        isHost = false;
        setupSocket();
    }

    function setupSocket() {
        peerConn.on('open', () => {
            peerConn.send({ type: 'JOIN', name: name });
            document.getElementById('status').innerText = "Handshake successful!";
        });

        peerConn.on('data', data => {
            if (data.type === 'JOIN') { 
                oppName = data.name; 
                peerConn.send({type:'START_GAME', name:name}); 
                startGame(); 
            }
            if (data.type === 'START_GAME') { 
                oppName = data.name; 
                startGame(); 
            }
            
            if (isHost) {
                if(data.p2Y !== undefined) p2.targetY = data.p2Y;
            } else {
                p1.y = data.p1Y;
                ball.x = data.bx; ball.y = data.by;
                score = data.score; rally = data.rally;
            }
        });

        peerConn.on('error', err => {
            alert("Connection error!");
            location.reload();
        });
    }

    // --- GAME ENGINE ---
    function uiSaveName() {
        name = document.getElementById('in-name').value || "PLAYER";
        document.getElementById('screen-name').classList.add('hidden');
        document.getElementById('screen-menu').classList.remove('hidden');
        loadLB();
    }

    function copyMyID() {
        const id = document.getElementById('display-id').innerText;
        navigator.clipboard.writeText(id);
        document.getElementById('status').innerText = "ID Copied to clipboard!";
    }

    function startSinglePlayer() { isHost = true; oppName = "CPU"; startGame(); }
    
    function startGame() { 
        state = 'PLAY'; 
        document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
        requestAnimationFrame(loop); 
    }

    function resetBall() {
        ball.x = GW/2; ball.y = GH/2;
        ball.dx *= -1; ball.speed = 1;
        if (rally > bestRally) bestRally = rally;
        rally = 0;
    }

    function update() {
        p1.y += (p1.targetY - p1.y) * 0.2;
        p2.y += (p2.targetY - p2.y) * 0.2;
        p1.y = Math.max(0, Math.min(GH - p1.h, p1.y));
        p2.y = Math.max(0, Math.min(GH - p2.h, p2.y));

        if (isHost) {
            if (oppName === "CPU") p2.targetY += (ball.y - (p2.y + p2.h/2)) * 0.1;
            ball.x += ball.dx * ball.speed;
            ball.y += ball.dy * ball.speed;
            ball.speed += 0.0006;

            if (ball.y < 0 || ball.y > GH) ball.dy *= -1;
            if (ball.dx < 0 && ball.x < 80 && ball.y > p1.y && ball.y < p1.y + p1.h) { ball.dx *= -1; ball.x = 81; rally++; }
            if (ball.dx > 0 && ball.x > GW - 80 && ball.y > p2.y && ball.y < p2.y + p2.h) { ball.dx *= -1; ball.x = GW - 81; rally++; }

            if (ball.x < 0) { score[1]++; resetBall(); }
            if (ball.x > GW) { score[0]++; resetBall(); }
            if (score[0] >= 7 || score[1] >= 7) endGame();
            if (peerConn) peerConn.send({ p1Y: p1.y, bx: ball.x, by: ball.y, score, rally });
        } else {
            if (peerConn) peerConn.send({ p2Y: p2.targetY });
        }
    }

    function draw() {
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,GW,GH);
        ctx.strokeStyle = '#222'; ctx.setLineDash([20, 20]);
        ctx.beginPath(); ctx.moveTo(GW/2, 0); ctx.lineTo(GW/2, GH); ctx.stroke();
        
        ctx.fillStyle = 'white'; ctx.font = '80px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText(score[0], GW/2 - 200, 150);
        ctx.fillText(score[1], GW/2 + 200, 150);
        ctx.font = '30px sans-serif'; ctx.fillText(`RALLY: ${rally}`, GW/2, 50);

        ctx.fillStyle = '#00f2ff'; ctx.shadowBlur = 20; ctx.shadowColor = '#00f2ff';
        ctx.fillRect(40, p1.y, p1.w, p1.h);
        ctx.fillStyle = '#ff007b'; ctx.shadowColor = '#ff007b';
        ctx.fillRect(GW - 40 - p2.w, p2.y, p2.w, p2.h);
        ctx.fillStyle = 'white'; ctx.shadowColor = 'white';
        ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
    }

    function loop() {
        if (state !== 'PLAY') return;
        update(); draw();
        requestAnimationFrame(loop);
    }

    function endGame() {
        state = 'END';
        const win = score[0] >= 7 ? name : oppName;
        document.getElementById('screen-win').classList.remove('hidden');
        document.getElementById('win-txt').innerText = win.toUpperCase() + " WINS!";
        document.getElementById('rally-txt').innerText = "Match Best Rally: " + bestRally;
        saveLB(win, bestRally);
    }

    function saveLB(w, r) {
        let history = JSON.parse(localStorage.getItem('pong_scores') || '[]');
        history.push({ name: w, rally: r });
        history.sort((a,b) => b.rally - a.rally);
        localStorage.setItem('pong_scores', JSON.stringify(history.slice(0, 5)));
    }

    function loadLB() {
        const history = JSON.parse(localStorage.getItem('pong_scores') || '[]');
        const div = document.getElementById('lb-content');
        if (history.length > 0) {
            div.innerHTML = '<b>TOP RALLIES:</b>' + history.map(h => `<div class="lb-row"><span>${h.name}</span><span>${h.rally} hits</span></div>`).join('');
        }
    }
</script>
</body>
</html>
